import pdfplumber
import pandas as pd
import re

def clean_table_data(table):
    """Limpia y procesa los datos de la tabla
    Clean and Process table data"""
    cleaned_data = []
    for row in table:
        cleaned_row = []
        for cell in row:
            if cell is None:
                cleaned_row.append("")
            else:
                # Limpiar espacios extra y saltos de línea
                cell = str(cell).replace('\n', ' ').strip()
                # Reemplazar múltiples espacios por uno solo
                cell = re.sub(r'\s+', ' ', cell)
                cleaned_row.append(cell)
        cleaned_data.append(cleaned_row)
    return cleaned_data

def extract_eps_tables(pdf_path, excel_path):
    """
    Extrae tablas específicas de reportes SEDAPAL
    """
    all_tables = []
    
    with pdfplumber.open(pdf_path) as pdf:
        for page_num, page in enumerate(pdf.pages, 1):
            print(f"Procesando página {page_num}...")
            
            # Extraer tablas de la página
            tables = page.extract_tables({
                "vertical_strategy": "lines",
                "horizontal_strategy": "lines",
                "explicit_vertical_lines": [],
                "explicit_horizontal_lines": [],
                "snap_tolerance": 3,
            })
            
            for table_num, table in enumerate(tables, 1):
                if table and len(table) > 1:  # Tabla no vacía
                    # Limpiar datos
                    cleaned_table = clean_table_data(table)
                    
                    # Convertir a DataFrame
                    df = pd.DataFrame(cleaned_table)
                    
                    # Agregar metadatos
                    df['PDF_Página'] = page_num
                    df['Tabla_Número'] = table_num
                    
                    all_tables.append(df)
                    
                    print(f"  Tabla {table_num}: {len(df)} filas × {len(df.columns)} columnas")
    
    # Procesar y guardar resultados
    if all_tables:
        print(f"\nTotal de tablas extraídas: {len(all_tables)}")
        
        # Guardar cada tabla en hojas separadas
        with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
            for i, df in enumerate(all_tables, 1):
                # Usar primera fila como encabezado si parece serlo
                if df.shape[0] > 1:
                    # Intentar detectar automáticamente si la primera fila es encabezado
                    header_row = 0 if any('indicador' in str(cell).lower() 
                                         for cell in df.iloc[0]) else None
                    
                    if header_row is not None:
                        df = pd.DataFrame(df.values[1:], columns=df.iloc[0])
                
                # Limpiar nombres de columnas
                df.columns = [str(col).strip().replace('\n', ' ') for col in df.columns]
                
                # Guardar en Excel
                sheet_name = f"Tabla_{i}"
                if len(sheet_name) > 31:  # Límite de Excel
                    sheet_name = sheet_name[:31]
                
                df.to_excel(writer, sheet_name=sheet_name, index=False)
        
        print(f"\nArchivo guardado: {excel_path}")
        
        # También mostrar un resumen de la primera tabla
        if all_tables:
            first_df = all_tables[0]
            print(f"\nMuestra de datos (primera tabla):")
            print(first_df.head())
            
    else:
        print("No se encontraron tablas en el PDF")

# Uso principal
if __name__ == "__main__":
    pdf_path = r"data_benchmarking.pdf"  # Cambia esto por tu archivo
    excel_path = r"data_benchmarking_2024.xlsx" #Nombrer para guardar el los datos en excel
    
    extract_eps_tables(pdf_path, excel_path)
